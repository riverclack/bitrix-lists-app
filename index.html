<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –°–ø–∏—Å–∫–æ–≤ 1–°</title>
    <script src="https://api.bitrix24.com/api/v1/"></script>
    <style>
        body { margin: 0; padding: 0; background: #fff; font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* === –≠–ö–†–ê–ù –ü–û–õ–Ø === */
        #field-screen { background: transparent; overflow: hidden; padding: 0; display: none; }
        .group-block { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .group-block:last-child { border-bottom: none; }
        .group-title { font-size: 10px; color: #999; font-weight: bold; margin-bottom: 5px; letter-spacing: 0.5px; }
        
        .control-row { margin-bottom: 8px; }
        .b24-label { font-size: 11px; color: #80868e; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
        .input-group { display: flex; align-items: center; gap: 5px; }
        .b24-select {
            flex-grow: 1; height: 34px; padding: 0 8px; font-size: 14px; color: #333; background: #fff;
            border: 1px solid #c6cdd3; border-radius: 2px; box-sizing: border-box; outline: none;
        }
        .b24-select:focus { border-color: #2fc6f6; }
        .b24-select:disabled { background: #f4f4f4; color: #aaa; }
        .btn-link {
            display: none; align-items: center; justify-content: center;
            width: 34px; height: 34px; border: 1px solid #c6cdd3; border-radius: 2px;
            background: #fff; text-decoration: none; color: #555; font-size: 16px;
        }
        .btn-link:hover { background: #f0f2f5; color: #2fc6f6; }

        /* === –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö === */
        #settings-screen { max-width: 900px; margin: 0 auto; padding: 20px; display: none; }
        .settings-card { background: #fff; border: 1px solid #edeef0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 30px; }
        
        /* –ë–ª–æ–∫ –≥—Ä—É–ø–ø—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
        .setting-group { border: 1px solid #e0e2e4; border-radius: 4px; padding: 15px; margin-bottom: 20px; background: #fdfdfd; position: relative; }
        .setting-group h4 { margin: 0 0 10px 0; font-size: 14px; color: #333; }
        .btn-remove-group { position: absolute; top: 10px; right: 10px; background: #ffdede; color: #d00; border: none; cursor: pointer; padding: 5px 10px; border-radius: 3px; font-size: 11px; }

        table.config-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; background: #fff; }
        table.config-table th { text-align: left; background: #f0f2f5; padding: 8px; font-size: 11px; color: #535c69; border-bottom: 1px solid #ddd; }
        table.config-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }
        table.config-table input { width: 100%; box-sizing: border-box; height: 30px; border: 1px solid #c6cdd3; border-radius: 3px; padding: 0 8px; font-size: 13px; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: #2fc6f6; color: #fff; }
        .btn-success { background: #9dcf00; color: #fff; font-size: 15px; padding: 12px 24px; }
        .btn-add { background: #eef2f4; color: #333; border: 1px solid #c6cdd3; font-size: 12px; }
        .btn-new-group { background: #dff0d8; color: #3c763d; border: 1px solid #d6e9c6; width: 100%; margin-bottom: 20px; padding: 10px; border-style: dashed; }
        .btn-del { background: #ff5752; color: #fff; width: 26px; height: 26px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; border-radius: 3px; }

        #debug-log {
            margin-top: 50px; padding: 10px; background: #222; color: #0f0; 
            font-family: monospace; font-size: 11px; max-height: 300px; overflow-y: auto;
            border-top: 5px solid #444; word-break: break-all;
        }
    </style>
</head>
<body>

<div id="loader-screen" style="text-align:center; padding: 20px; color: #888;">
    <h3>–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
</div>

<div id="settings-screen">
    <div class="settings-card">
        <h2 style="margin-top:0;">‚öôÔ∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–æ–ª–µ–π 1–°</h2>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">
            –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª–µ–π. –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–ø–∏—Å–∫–æ–≤.
        </p>
        
        <label style="display:block; margin-bottom:5px; font-weight:bold;">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—â–µ–≥–æ –ø–æ–ª—è –≤ CRM:</label>
        <input type="text" id="conf-title" style="width:100%; max-width:400px; height:36px; border:1px solid #ccc; margin-bottom:20px;">

        <div id="groups-container">
            </div>

        <button class="btn btn-new-group" onclick="Settings.addNewGroup()">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É —Å–ø–∏—Å–∫–æ–≤</button>

        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

        <button class="btn btn-success" onclick="Settings.save()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ</button>
        <span id="save-msg" style="margin-left:10px; font-weight:bold;"></span>
    </div>
</div>

<div id="field-screen">
    <div id="field-render-area"></div>
    <div id="field-msg" style="color:#999; text-align:center; padding:10px;"></div>
</div>

<div id="debug-log">Log started...</div>

<script>
function log(msg) {
    console.log(msg);
    const el = document.getElementById('debug-log');
    if(el) {
        const time = new Date().toLocaleTimeString();
        el.innerHTML = `[${time}] ${msg}<br>` + el.innerHTML;
    }
}

const App = {
    config: null,
    domain: null,

    init: function() {
        const params = new URLSearchParams(window.location.search);
        const placementType = params.get('PLACEMENT') || 'DEFAULT'; 
        
        BX24.init(() => {
            this.domain = BX24.getAuth().domain;
            
            this.loadConfig((loadedConfig) => {
                this.config = loadedConfig;

                if (placementType === 'USERFIELD_TYPE') {
                    // –†–ï–ñ–ò–ú –ü–û–õ–Ø
                    BX24.placement.info((info) => {
                        this.renderFieldMode(info.options);
                    });
                } else {
                    // –†–ï–ñ–ò–ú –ù–ê–°–¢–†–û–ï–ö
                    this.renderSettingsMode();
                }
            });
        });
    },

    loadConfig: function(callback) {
        BX24.callMethod('app.option.get', { option: 'riverclack_config_v3' }, (res) => {
            let data = res.data();
            
            // --- –ú–ò–ì–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• ---
            // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ñ–∏–≥ (–±–µ–∑ –≥—Ä—É–ø–ø), –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –µ–≥–æ
            if (!data) {
                // –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ v2
                BX24.callMethod('app.option.get', { option: 'riverclack_config_v2' }, (res2) => {
                    let oldData = res2.data();
                    if (oldData && oldData.levels) {
                        log("Migrating config from v2 to v3...");
                        callback({
                            title: oldData.title,
                            groups: [{ title: "–û—Å–Ω–æ–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞", levels: oldData.levels }]
                        });
                    } else {
                        callback(this.getDefaultConfig());
                    }
                });
                return;
            }
            // --- –ö–û–ù–ï–¶ –ú–ò–ì–†–ê–¶–ò–ò ---

            callback(data);
        });
    },

    getDefaultConfig: function() {
        return {
            title: "1–° –°–ø–∏—Å–∫–∏",
            groups: [
                {
                    title: "–î–æ–≥–æ–≤–æ—Ä—ã –∏ –ó–∞–∫–∞–∑—ã",
                    levels: [
                        { name: "–î–æ–≥–æ–≤–æ—Ä", listId: "55", linkProp: "", crmField: "UF_CRM_1766155842" },
                        { name: "–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è", listId: "57", linkProp: "PROPERTY_PROPERTY_PARENT_DOGOVOR", crmField: "UF_CRM_1766155890" },
                        { name: "–ó–∞–∫–∞–∑", listId: "59", linkProp: "PROPERTY_PROPERTY_PARENT_SPECIFICATION", crmField: "UF_CRM_1766155959" }
                    ]
                }
            ]
        };
    },

    renderSettingsMode: function() {
        document.getElementById('loader-screen').style.display = 'none';
        document.getElementById('settings-screen').style.display = 'block';
        document.getElementById('debug-log').style.display = 'block';

        document.getElementById('conf-title').value = this.config.title || "1C –°–ø–∏—Å–∫–∏";
        const container = document.getElementById('groups-container');
        container.innerHTML = '';
        
        (this.config.groups || []).forEach((grp, idx) => Settings.renderGroup(grp, idx));
        log("Settings rendered.");
    },

    renderFieldMode: function(options) {
        document.getElementById('loader-screen').style.display = 'none';
        document.getElementById('field-screen').style.display = 'block';
        document.getElementById('debug-log').style.display = 'none';
        
        FieldLogic.start(options.ENTITY_ID);
    }
};

const Settings = {
    // –†–µ–Ω–¥–µ—Ä–∏—Ç –±–ª–æ–∫ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã
    renderGroup: function(groupData = {}, index) {
        const container = document.getElementById('groups-container');
        const div = document.createElement('div');
        div.className = 'setting-group';
        div.dataset.index = index; // –ß—Ç–æ–±—ã –∑–Ω–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫
        
        div.innerHTML = `
            <button class="btn-remove-group" onclick="Settings.removeGroup(this)">–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
            <label style="font-size:12px; font-weight:bold;">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–¥–ª—è —Å–µ–±—è):</label>
            <input type="text" class="group-title-input" value="${groupData.title || ''}" style="width:100%; margin-bottom:10px; border:1px solid #ddd;">
            
            <table class="config-table">
                <thead>
                    <tr>
                        <th width="20%">–ò–º—è (Label)</th>
                        <th width="10%">List ID</th>
                        <th width="25%">–°–≤—è–∑—å (–ö–æ–¥ –≤ 1–°)</th>
                        <th width="25%">–ü–æ–ª–µ CRM (–ö–æ–¥)</th>
                        <th width="5%"></th>
                    </tr>
                </thead>
                <tbody class="levels-tbody"></tbody>
            </table>
            <button class="btn btn-add" onclick="Settings.addLevelRow(this)">+ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –≤ —ç—Ç—É –≥—Ä—É–ø–ø—É</button>
        `;

        container.appendChild(div);

        // –†–µ–Ω–¥–µ—Ä–∏–º —É—Ä–æ–≤–Ω–∏ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã
        const tbody = div.querySelector('.levels-tbody');
        (groupData.levels || []).forEach(lvl => {
            this.appendLevelRow(tbody, lvl);
        });
    },

    addNewGroup: function() {
        this.renderGroup({ title: "–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞", levels: [] }, document.querySelectorAll('.setting-group').length);
    },

    removeGroup: function(btn) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É —Å–ø–∏—Å–∫–æ–≤?')) {
            btn.closest('.setting-group').remove();
        }
    },

    addLevelRow: function(btn) {
        const tbody = btn.closest('.setting-group').querySelector('.levels-tbody');
        this.appendLevelRow(tbody, {});
    },

    appendLevelRow: function(tbody, data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="inp-name" value="${data.name || ''}"></td>
            <td><input type="text" class="inp-list" value="${data.listId || ''}"></td>
            <td><input type="text" class="inp-link" value="${data.linkProp || ''}"></td>
            <td><input type="text" class="inp-crm" value="${data.crmField || ''}"></td>
            <td><button class="btn btn-del" onclick="this.closest('tr').remove()">√ó</button></td>
        `;
        tbody.appendChild(tr);
    },

    save: function() {
        const msg = document.getElementById('save-msg');
        msg.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        
        const newConfig = {
            title: document.getElementById('conf-title').value,
            groups: []
        };

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≥—Ä—É–ø–ø–∞–º
        document.querySelectorAll('.setting-group').forEach(groupDiv => {
            const groupObj = {
                title: groupDiv.querySelector('.group-title-input').value,
                levels: []
            };

            groupDiv.querySelectorAll('tbody tr').forEach(tr => {
                groupObj.levels.push({
                    name: tr.querySelector('.inp-name').value,
                    listId: tr.querySelector('.inp-list').value,
                    linkProp: tr.querySelector('.inp-link').value,
                    crmField: tr.querySelector('.inp-crm').value
                });
            });

            newConfig.groups.push(groupObj);
        });

        BX24.callMethod('app.option.set', { options: { riverclack_config_v3: newConfig } }, (res) => {
            if(res.error()) {
                msg.innerText = "–û—à–∏–±–∫–∞: " + res.error();
                return;
            }
            
            const handlerUrl = window.location.href.split('?')[0];
            BX24.callMethod('userfieldtype.add', {
                USER_TYPE_ID: 'riverclack_lists_pro', 
                HANDLER: handlerUrl,
                TITLE: newConfig.title,
                DESCRIPTION: '–ú—É–ª—å—Ç–∏-—Å–ø–∏—Å–∫–∏ 1–°'
            }, (res2) => {
                msg.innerText = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
            });
        });
    }
};

const FieldLogic = {
    entityId: 0,
    groups: [],

    start: function(id) {
        this.entityId = id;
        this.groups = App.config.groups || [];
        
        const container = document.getElementById('field-render-area');
        container.innerHTML = '';
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É
        this.groups.forEach((grp, gIdx) => {
            const grpDiv = document.createElement('div');
            grpDiv.className = 'group-block';
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ, –ø–æ–ª–µ–∑–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å)
            if (this.groups.length > 1 && grp.title) {
                grpDiv.innerHTML += `<div class="group-title">${grp.title}</div>`;
            }

            grp.levels.forEach((lvl, lIdx) => {
                const row = document.createElement('div');
                row.className = 'control-row';
                // ID —Ç–µ–ø–µ—Ä—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π: sel-0-0 (–≥—Ä—É–ø–ø–∞-—É—Ä–æ–≤–µ–Ω—å)
                row.innerHTML = `
                    <div class="b24-label">${lvl.name}</div>
                    <div class="input-group">
                        <select id="sel-${gIdx}-${lIdx}" class="b24-select" disabled><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                        <a id="link-${gIdx}-${lIdx}" class="btn-link" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å">üîó</a>
                    </div>
                `;
                grpDiv.appendChild(row);
            });
            
            container.appendChild(grpDiv);
        });
        
        // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM)
        this.groups.forEach((grp, gIdx) => {
            grp.levels.forEach((lvl, lIdx) => {
                 document.getElementById(`sel-${gIdx}-${lIdx}`).onchange = () => this.onChange(gIdx, lIdx);
            });
        });

        if (this.entityId == 0) {
            document.getElementById('field-msg').innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–¥–µ–ª–∫—É";
            return;
        }

        this.sync();
    },

    sync: function() {
        BX24.callMethod('crm.deal.get', { ID: this.entityId }, res => {
            if(!res.data()) return;
            const data = res.data();
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ —É—Ä–æ–≤–Ω—è–º
            this.groups.forEach(grp => {
                grp.levels.forEach(lvl => {
                    lvl.val = data[lvl.crmField];
                });
            });

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –Ω—É–ª–µ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –¥–ª—è –ö–ê–ñ–î–û–ô –≥—Ä—É–ø–ø—ã
            this.groups.forEach((_, gIdx) => {
                this.loadLevel(gIdx, 0, null);
            });
        });
    },

    loadLevel: function(gIdx, lIdx, parentVal) {
        const grp = this.groups[gIdx];
        if(lIdx >= grp.levels.length) return;

        const lvl = grp.levels[lIdx];
        const el = document.getElementById(`sel-${gIdx}-${lIdx}`);
        
        // –û—á–∏—Å—Ç–∫–∞ –Ω–∏–∂–Ω–∏—Ö —É—Ä–æ–≤–Ω–µ–π –≤ –≠–¢–û–ô –≥—Ä—É–ø–ø–µ
        for(let i = lIdx; i < grp.levels.length; i++) {
            const n = document.getElementById(`sel-${gIdx}-${i}`);
            n.innerHTML = '<option value="">' + (i === lIdx ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '...') + '</option>';
            n.disabled = true;
            document.getElementById(`link-${gIdx}-${i}`).style.display = 'none';
        }

        const filter = {};
        if (lIdx > 0) {
            if (!parentVal) {
                el.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—à–µ</option>';
                return;
            }
            filter[lvl.linkProp] = parentVal;
        }

        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists',
            IBLOCK_ID: lvl.listId,
            FILTER: filter,
            SELECT: ['ID', 'NAME']
        }, res => {
            el.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>';
            if(res.data()) {
                res.data().forEach(item => {
                    el.innerHTML += `<option value="${item.ID}">${item.NAME}</option>`;
                });
            }
            el.disabled = false;

            if (lvl.val) {
                const exists = [...el.options].some(o => o.value == lvl.val);
                if (exists) {
                    el.value = lvl.val;
                    this.updateLink(gIdx, lIdx, lvl.val);
                    // –†–µ–∫—É—Ä—Å–∏—è –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∂–µ
                    this.loadLevel(gIdx, lIdx + 1, lvl.val);
                } else {
                    lvl.val = null;
                }
            }
            
            // –†–µ—Å–∞–π–∑
            BX24.placement.call('resizeWindow', { width: '100%', height: document.body.scrollHeight + 20 });
        });
    },

    onChange: function(gIdx, lIdx) {
        const val = document.getElementById(`sel-${gIdx}-${lIdx}`).value;
        const lvl = this.groups[gIdx].levels[lIdx];
        
        this.updateLink(gIdx, lIdx, val);
        
        BX24.callMethod('crm.deal.update', {
            ID: this.entityId,
            FIELDS: { [lvl.crmField]: val }
        });

        if (lIdx + 1 < this.groups[gIdx].levels.length) {
            this.loadLevel(gIdx, lIdx + 1, val);
        }
    },

    updateLink: function(gIdx, lIdx, recId) {
        const link = document.getElementById(`link-${gIdx}-${lIdx}`);
        const listId = this.groups[gIdx].levels[lIdx].listId;
        if(recId && App.domain) {
            link.href = `https://${App.domain}/company/lists/${listId}/element/0/${recId}/`;
            link.style.display = 'flex';
        } else {
            link.style.display = 'none';
        }
    }
};

App.init();
</script>
</body>
</html>
