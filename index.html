<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1C –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä</title>
    <script src="https://api.bitrix24.com/api/v1/"></script>
    <style>
        body { margin: 0; padding: 0; background: transparent; font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; }
        
        #app { padding: 0; }
        
        .control-row {
            margin-bottom: 8px;
        }

        .b24-label { 
            font-size: 11px; color: #80868e; font-weight: 600; text-transform: uppercase; margin-bottom: 2px;
        }
        
        /* –ì—Ä—É–ø–ø–∞: –°–µ–ª–µ–∫—Ç + –°—Å—ã–ª–∫–∞ */
        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .b24-select {
            flex-grow: 1; /* –°–µ–ª–µ–∫—Ç –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
            display: block; height: 34px; padding: 0 8px;
            font-size: 14px; color: #333; background: #fff;
            border: 1px solid #c6cdd3; border-radius: 2px;
            box-sizing: border-box; outline: none;
        }
        .b24-select:focus { border-color: #2fc6f6; }
        .b24-select:disabled { background: #f4f4f4; color: #aaa; }

        /* –ö–Ω–æ–ø–∫–∞-—Å—Å—ã–ª–∫–∞ */
        .btn-link {
            display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            align-items: center; justify-content: center;
            width: 34px; height: 34px;
            border: 1px solid #c6cdd3; border-radius: 2px;
            background: #fff; text-decoration: none;
            color: #555; font-size: 16px;
            transition: 0.2s;
        }
        .btn-link:hover { background: #f0f2f5; border-color: #b0b8c0; color: #2fc6f6; }

        .install-wrap { text-align: center; padding: 20px; }
        .btn-install {
            padding: 10px 20px; background: #2fc6f6; color: #fff; 
            border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        
        #main-screen, #loader { display: none; }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

<div id="app">
    <div id="install-screen" class="install-wrap">
        <h3>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ü–æ–ª—è</h3>
        <button class="btn-install" onclick="app.install()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å "–ü—É–ª—å—Ç 1–°"</button>
    </div>

    <div id="loader" style="padding: 10px; color: #999; font-size: 12px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö 1–°...</div>

    <div id="main-screen">
        <div class="control-row">
            <div class="b24-label">–î–æ–≥–æ–≤–æ—Ä</div>
            <div class="input-group">
                <select id="select-dogovor" class="b24-select"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                <a id="link-dogovor" class="btn-link" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ">üîó</a>
            </div>
        </div>

        <div class="control-row">
            <div class="b24-label">–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è</div>
            <div class="input-group">
                <select id="select-spec" class="b24-select" disabled><option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä</option></select>
                <a id="link-spec" class="btn-link" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ">üîó</a>
            </div>
        </div>

        <div class="control-row">
            <div class="b24-label">–ó–∞–∫–∞–∑ –ö–ª–∏–µ–Ω—Ç–∞</div>
            <div class="input-group">
                <select id="select-order" class="b24-select" disabled><option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é</option></select>
                <a id="link-order" class="btn-link" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ">üîó</a>
            </div>
        </div>
    </div>
</div>

<script>
const CONFIG = {
    LISTS: { DOGOVOR: 55, SPEC: 57, ORDER: 59 },
    PROPS: {
        LINK_TO_DOGOVOR: "PROPERTY_PROPERTY_PARENT_DOGOVOR", 
        LINK_TO_SPEC: "PROPERTY_PROPERTY_PARENT_SPECIFICATION", 
        
        DEAL_DOGOVOR: "UF_CRM_1766155842",
        DEAL_SPEC: "UF_CRM_1766155890",
        DEAL_ORDER: "UF_CRM_1766155959"
    },
    USER_TYPE_ID: 'riverclack_1c_v2' 
};

const app = {
    dealId: 0,
    domain: null, // –•—Ä–∞–Ω–∏–º –¥–æ–º–µ–Ω –ø–æ—Ä—Ç–∞–ª–∞
    
    init: function() {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–º–µ–Ω –¥–ª—è —Å—Å—ã–ª–æ–∫
        const params = new URLSearchParams(window.location.search);
        this.domain = params.get('DOMAIN');
        if(!this.domain && document.referrer) {
             try { this.domain = new URL(document.referrer).hostname; } catch(e){}
        }

        const placementOptions = params.get('PLACEMENT_OPTIONS');
        if (placementOptions) {
            try {
                const options = JSON.parse(placementOptions);
                if (options.ENTITY_ID) {
                    this.start(options.ENTITY_ID);
                    return;
                }
            } catch(e) { console.error(e); }
        }

        // –ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –¥–æ–º–µ–Ω –æ—Ç—Ç—É–¥–∞
        BX24.init(() => {
            if(!this.domain) this.domain = BX24.getAuth().domain;
        });

        document.getElementById('install-screen').style.display = 'block';
    },

    install: function() {
        const handlerUrl = window.location.href.split('?')[0];
        BX24.callMethod('userfieldtype.add', {
            USER_TYPE_ID: CONFIG.USER_TYPE_ID,
            HANDLER: handlerUrl,
            TITLE: '–ü—É–ª—å—Ç 1–° (–°–ø–∏—Å–∫–∏)',
            DESCRIPTION: '–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ã–±–æ—Ä–∞ –î–æ–≥–æ–≤–æ—Ä–∞, –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –ó–∞–∫–∞–∑–∞'
        }, res => {
            if(res.error()) alert('–û—à–∏–±–∫–∞: ' + res.error());
            else alert('–£—Å–ø–µ—à–Ω–æ! –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ –≤ —Å–¥–µ–ª–∫—É.');
        });
    },

    start: function(id) {
        document.getElementById('install-screen').style.display = 'none';
        document.getElementById('loader').style.display = 'block';
        this.dealId = id;
        
        if (this.dealId == 0) {
            document.getElementById('loader').innerText = "–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–¥–µ–ª–∫—É!";
            return;
        }

        logic.loadDogovors();
        logic.syncWithDeal();
    }
};

const logic = {
    savedOrder: null,

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏
    updateLink: function(linkId, listId, recordId) {
        const linkEl = document.getElementById(linkId);
        if (recordId && app.domain) {
            linkEl.href = `https://${app.domain}/company/lists/${listId}/element/0/${recordId}/`;
            linkEl.style.display = 'flex';
        } else {
            linkEl.style.display = 'none';
        }
    },

    loadDogovors: function() {
        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists', IBLOCK_ID: CONFIG.LISTS.DOGOVOR, 
            SELECT: ['ID', 'NAME'] 
        }, res => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('main-screen').style.display = 'block';
            
            // –†–µ—Å–∞–π–∑ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            const height = document.body.scrollHeight + 20;
            BX24.placement.call('resizeWindow', { width: '100%', height: height });

            let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä</option>';
            res.data().forEach(i => html += `<option value="${i.ID}">${i.NAME}</option>`);
            document.getElementById('select-dogovor').innerHTML = html;
        });
    },

    loadSpecs: function(parentId, selected = null) {
        const el = document.getElementById('select-spec');
        const elOrd = document.getElementById('select-order');
        el.innerHTML = '<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>'; el.disabled = true;
        elOrd.innerHTML = '<option>...</option>'; elOrd.disabled = true;
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
        logic.updateLink('link-spec', CONFIG.LISTS.SPEC, null);
        logic.updateLink('link-order', CONFIG.LISTS.ORDER, null);

        if(!parentId) {
             el.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä</option>';
             return;
        }

        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists', IBLOCK_ID: CONFIG.LISTS.SPEC,
            FILTER: { [CONFIG.PROPS.LINK_TO_DOGOVOR]: parentId }, 
            SELECT: ['ID', 'NAME']
        }, res => {
            el.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é</option>';
            res.data().forEach(i => el.innerHTML += `<option value="${i.ID}">${i.NAME}</option>`);
            el.disabled = false;
            
            if(selected) { 
                el.value = selected; 
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
                logic.updateLink('link-spec', CONFIG.LISTS.SPEC, selected);
                this.loadOrders(selected, logic.savedOrder); 
            }
        });
    },

    loadOrders: function(parentId, selected = null) {
        const el = document.getElementById('select-order');
        el.innerHTML = '<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>'; el.disabled = true;
        logic.updateLink('link-order', CONFIG.LISTS.ORDER, null);

        if(!parentId) {
            el.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é</option>';
            return;
        }

        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists', IBLOCK_ID: CONFIG.LISTS.ORDER,
            FILTER: { [CONFIG.PROPS.LINK_TO_SPEC]: parentId }, 
            SELECT: ['ID', 'NAME']
        }, res => {
            el.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑</option>';
            res.data().forEach(i => el.innerHTML += `<option value="${i.ID}">${i.NAME}</option>`);
            el.disabled = false;
            if(selected) {
                el.value = selected;
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –∑–∞–∫–∞–∑–∞
                logic.updateLink('link-order', CONFIG.LISTS.ORDER, selected);
            }
        });
    },

    syncWithDeal: function() {
        BX24.callMethod('crm.deal.get', { ID: app.dealId }, res => {
            if(!res.data()) return;
            const data = res.data();
            const dogovorId = data[CONFIG.PROPS.DEAL_DOGOVOR];
            const specId = data[CONFIG.PROPS.DEAL_SPEC];
            this.savedOrder = data[CONFIG.PROPS.DEAL_ORDER];

            if(dogovorId) {
                const waiter = setInterval(() => {
                    const el = document.getElementById('select-dogovor');
                    if(el.options.length > 1) {
                        clearInterval(waiter);
                        el.value = dogovorId;
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞
                        logic.updateLink('link-dogovor', CONFIG.LISTS.DOGOVOR, dogovorId);
                        this.loadSpecs(dogovorId, specId);
                    }
                }, 100);
            }
        });
    },

    save: function() {
        BX24.callMethod('crm.deal.update', {
            ID: app.dealId,
            FIELDS: {
                [CONFIG.PROPS.DEAL_DOGOVOR]: document.getElementById('select-dogovor').value,
                [CONFIG.PROPS.DEAL_SPEC]: document.getElementById('select-spec').value,
                [CONFIG.PROPS.DEAL_ORDER]: document.getElementById('select-order').value
            }
        });
    }
};

// –°–æ–±—ã—Ç–∏—è
document.getElementById('select-dogovor').onchange = function() { 
    logic.updateLink('link-dogovor', CONFIG.LISTS.DOGOVOR, this.value);
    logic.loadSpecs(this.value); 
    logic.save(); 
};
document.getElementById('select-spec').onchange = function() { 
    logic.updateLink('link-spec', CONFIG.LISTS.SPEC, this.value);
    logic.loadOrders(this.value); 
    logic.save(); 
};
document.getElementById('select-order').onchange = function() { 
    logic.updateLink('link-order', CONFIG.LISTS.ORDER, this.value);
    logic.save(); 
};

app.init();
</script>
</body>
</html>
