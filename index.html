<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –°–ø–∏—Å–∫–æ–≤ 1–°</title>
    <script src="https://api.bitrix24.com/api/v1/"></script>
    <style>
        body { margin: 0; padding: 0; background: #fff; font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* === –≠–ö–†–ê–ù –ü–û–õ–Ø (–í–ù–£–¢–†–ò –°–î–ï–õ–ö–ò) === */
        #field-screen { background: transparent; overflow: hidden; padding: 0; display: none; }
        .control-row { margin-bottom: 8px; }
        .b24-label { font-size: 11px; color: #80868e; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
        .input-group { display: flex; align-items: center; gap: 5px; }
        .b24-select {
            flex-grow: 1; height: 34px; padding: 0 8px; font-size: 14px; color: #333; background: #fff;
            border: 1px solid #c6cdd3; border-radius: 2px; box-sizing: border-box; outline: none;
        }
        .b24-select:focus { border-color: #2fc6f6; }
        .b24-select:disabled { background: #f4f4f4; color: #aaa; }
        .btn-link {
            display: none; align-items: center; justify-content: center;
            width: 34px; height: 34px; border: 1px solid #c6cdd3; border-radius: 2px;
            background: #fff; text-decoration: none; color: #555; font-size: 16px;
        }
        .btn-link:hover { background: #f0f2f5; color: #2fc6f6; }

        /* === –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö (–ê–î–ú–ò–ù–ö–ê) === */
        #settings-screen { max-width: 900px; margin: 0 auto; padding: 20px; display: none; }
        .settings-card { background: #fff; border: 1px solid #edeef0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 30px; }
        
        h2 { margin-top: 0; margin-bottom: 20px; color: #333; }
        .help-text { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px; color: #555; font-size: 13px; line-height: 1.5; border-left: 4px solid #2fc6f6; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px; color: #333; }
        .form-input { width: 100%; max-width: 400px; height: 36px; padding: 0 10px; border: 1px solid #c6cdd3; border-radius: 3px; }

        /* –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π */
        table.config-table { width: 100%; border-collapse: collapse; }
        table.config-table th { text-align: left; background: #f0f2f5; padding: 10px; font-size: 12px; color: #535c69; border-bottom: 2px solid #ddd; }
        table.config-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; }
        table.config-table input { width: 100%; box-sizing: border-box; height: 34px; border: 1px solid #c6cdd3; border-radius: 3px; padding: 0 8px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: #2fc6f6; color: #fff; }
        .btn-primary:hover { background: #1db5e5; }
        .btn-success { background: #9dcf00; color: #fff; margin-top: 20px; }
        .btn-add { background: #eef2f4; color: #333; border: 1px solid #c6cdd3; margin-top: 10px; font-size: 12px; }
        .btn-del { background: #ff5752; color: #fff; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center; }

        #loader-screen { display: flex; justify-content: center; align-items: center; height: 100vh; color: #888; }
    </style>
</head>
<body>

<div id="loader-screen">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</div>

<div id="settings-screen">
    <div class="settings-card">
        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–∏—Å–∏–º—ã—Ö –ø–æ–ª–µ–π</h2>
        
        <div class="help-text">
            <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b><br>
            1. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∏–∂–µ (–Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π, ID —Å–ø–∏—Å–∫–æ–≤).<br>
            2. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ".<br>
            3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ CRM (–°–¥–µ–ª–∫–∞), –Ω–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–µ" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –Ω–æ–≤—ã–π —Ç–∏–ø –ø–æ–ª—è.
        </div>

        <div class="form-group">
            <label class="form-label">1. –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–ª—è (–∫–∞–∫ –æ–Ω–æ –±—É–¥–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –ø–æ–ª–µ–π CRM)</label>
            <input type="text" id="conf-title" class="form-input" value="1–° –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏">
        </div>

        <div class="form-group">
            <label class="form-label">2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω–µ–π</label>
            <table class="config-table">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="20%">–ù–∞–∑–≤–∞–Ω–∏–µ (Label)</th>
                        <th width="10%">ID –°–ø–∏—Å–∫–∞</th>
                        <th width="25%">–ö–æ–¥ —Å–≤—è–∑–∏ (–≤ –°–ø–∏—Å–∫–µ)</th>
                        <th width="25%">–ö–æ–¥ –ø–æ–ª—è CRM (–ö—É–¥–∞ –ø–∏—Å–∞—Ç—å)</th>
                        <th width="5%"></th>
                    </tr>
                </thead>
                <tbody id="levels-container"></tbody>
            </table>
            <button class="btn btn-add" onclick="Settings.addRow()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
        </div>

        <div class="form-group">
            <button class="btn btn-success" onclick="Settings.save()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ</button>
            <span id="save-msg" style="margin-left:15px; font-weight:bold;"></span>
        </div>
    </div>
</div>

<div id="field-screen">
    <div id="dynamic-fields"></div>
    <div id="field-msg" style="color:#999; text-align:center; padding:10px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<script>
// --- –Ø–î–†–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
const App = {
    config: null,
    domain: null,
    placement: null,

    init: function() {
        BX24.init(() => {
            this.domain = BX24.getAuth().domain;
            
            // 1. –£–∑–Ω–∞–µ–º, –≥–¥–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è (–í—Å—Ç—Ä–æ–π–∫–∞ –∏–ª–∏ –ê–¥–º–∏–Ω–∫–∞?)
            BX24.placement.info((info) => {
                this.placement = info.placement;
                
                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                BX24.callMethod('app.option.get', { option: 'riverclack_config_v2' }, (res) => {
                    this.config = res.data() || this.getDefaultConfig();
                    
                    if (this.placement === 'USERFIELD_TYPE') {
                        // –ú—ã –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è –≤ CRM
                        this.renderFieldMode(info.options);
                    } else {
                        // –ú—ã –≤ –º–µ–Ω—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (–ê–¥–º–∏–Ω–∫–∞)
                        this.renderSettingsMode();
                    }
                });
            });
        });
    },

    getDefaultConfig: function() {
        return {
            title: "1–° –°–≤—è–∑–∞–Ω–Ω—ã–µ –°–ø–∏—Å–∫–∏",
            levels: [
                { name: "–î–æ–≥–æ–≤–æ—Ä", listId: "55", linkProp: "", crmField: "UF_CRM_1766155842" },
                { name: "–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è", listId: "57", linkProp: "PROPERTY_PROPERTY_PARENT_DOGOVOR", crmField: "UF_CRM_1766155890" },
                { name: "–ó–∞–∫–∞–∑", listId: "59", linkProp: "PROPERTY_PROPERTY_PARENT_SPECIFICATION", crmField: "UF_CRM_1766155959" }
            ]
        };
    },

    // --- –†–ï–ñ–ò–ú –ù–ê–°–¢–†–û–ï–ö ---
    renderSettingsMode: function() {
        document.getElementById('loader-screen').style.display = 'none';
        document.getElementById('settings-screen').style.display = 'block';
        
        document.getElementById('conf-title').value = this.config.title;
        const container = document.getElementById('levels-container');
        container.innerHTML = '';
        
        this.config.levels.forEach(lvl => Settings.addRow(lvl));
    },

    // --- –†–ï–ñ–ò–ú –ü–û–õ–Ø ---
    renderFieldMode: function(options) {
        document.getElementById('loader-screen').style.display = 'none';
        document.getElementById('field-screen').style.display = 'block';
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–≥–∏–∫—É –ø–æ–ª–µ–π —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º ID —Å—É—â–Ω–æ—Å—Ç–∏
        FieldLogic.start(options.ENTITY_ID);
    }
};

// --- –õ–û–ì–ò–ö–ê –ù–ê–°–¢–†–û–ï–ö (ADMIN) ---
const Settings = {
    addRow: function(data = {}) {
        const container = document.getElementById('levels-container');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${container.children.length + 1}</td>
            <td><input type="text" class="inp-name" value="${data.name || ''}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"></td>
            <td><input type="text" class="inp-list" value="${data.listId || ''}" placeholder="55"></td>
            <td><input type="text" class="inp-link" value="${data.linkProp || ''}" placeholder="–ö–æ–¥ —Å–≤—è–∑–∏"></td>
            <td><input type="text" class="inp-crm" value="${data.crmField || ''}" placeholder="UF_CRM_..."></td>
            <td><button class="btn btn-del" onclick="this.closest('tr').remove()">√ó</button></td>
        `;
        container.appendChild(tr);
    },

    save: function() {
        const msg = document.getElementById('save-msg');
        msg.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        msg.style.color = "blue";

        // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        const newConfig = {
            title: document.getElementById('conf-title').value,
            levels: []
        };

        document.querySelectorAll('#levels-container tr').forEach(tr => {
            newConfig.levels.push({
                name: tr.querySelector('.inp-name').value,
                listId: tr.querySelector('.inp-list').value,
                linkProp: tr.querySelector('.inp-link').value,
                crmField: tr.querySelector('.inp-crm').value
            });
        });

        // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        BX24.callMethod('app.option.set', { options: { riverclack_config_v2: newConfig } }, () => {
            
            // 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—è
            const handlerUrl = window.location.href.split('?')[0];
            
            BX24.callMethod('userfieldtype.add', {
                USER_TYPE_ID: 'riverclack_lists_pro', // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç–∏–ø–∞ –ø–æ–ª—è
                HANDLER: handlerUrl,
                TITLE: newConfig.title,
                DESCRIPTION: '–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º—ã–µ —Å–ø–∏—Å–∫–∏'
            }, (res) => {
                if (res.error()) {
                    msg.innerText = "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + res.error();
                    msg.style.color = "red";
                } else {
                    msg.innerText = "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –ü–æ–ª–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.";
                    msg.style.color = "green";
                }
            });
        });
    }
};

// --- –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´ –í CRM (USER) ---
const FieldLogic = {
    entityId: 0,
    levels: [],

    start: function(id) {
        this.entityId = id;
        this.levels = App.config.levels; // –ë–µ—Ä–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        
        // 1. –°—Ç—Ä–æ–∏–º HTML
        const container = document.getElementById('dynamic-fields');
        container.innerHTML = '';
        
        this.levels.forEach((lvl, idx) => {
            const row = document.createElement('div');
            row.className = 'control-row';
            row.innerHTML = `
                <div class="b24-label">${lvl.name}</div>
                <div class="input-group">
                    <select id="sel-${idx}" class="b24-select" disabled><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                    <a id="link-${idx}" class="btn-link" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å">üîó</a>
                </div>
            `;
            container.appendChild(row);
            
            // –°–æ–±—ã—Ç–∏–µ
            document.getElementById(`sel-${idx}`).onchange = () => this.onChange(idx);
        });

        document.getElementById('field-msg').style.display = 'none';

        if (this.entityId == 0) {
            document.getElementById('field-msg').style.display = 'block';
            document.getElementById('field-msg').innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–¥–µ–ª–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã";
            return;
        }

        // 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞
        this.sync();
    },

    sync: function() {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π —Å–¥–µ–ª–∫–∏
        BX24.callMethod('crm.deal.get', { ID: this.entityId }, res => {
            if(!res.data()) return;
            const data = res.data();
            
            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
            this.levels.forEach(lvl => {
                lvl.val = data[lvl.crmField];
            });

            // –ù–∞—á–∏–Ω–∞–µ–º –∫–∞—Å–∫–∞–¥–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è
            this.loadLevel(0, null);
        });
    },

    loadLevel: function(idx, parentVal) {
        if(idx >= this.levels.length) return;

        const lvl = this.levels[idx];
        const el = document.getElementById(`sel-${idx}`);
        const link = document.getElementById(`link-${idx}`);

        // –û—á–∏—Å—Ç–∫–∞ –Ω–∏–∂–Ω–∏—Ö —É—Ä–æ–≤–Ω–µ–π
        for(let i = idx; i < this.levels.length; i++) {
            const nextEl = document.getElementById(`sel-${i}`);
            nextEl.innerHTML = '<option value="">' + (i === idx ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '...') + '</option>';
            nextEl.disabled = true;
            document.getElementById(`link-${i}`).style.display = 'none';
        }

        // –§–∏–ª—å—Ç—Ä
        const filter = {};
        if (idx > 0) {
            if (!parentVal) {
                el.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—à–µ</option>';
                return;
            }
            filter[lvl.linkProp] = parentVal;
        }

        // –ó–∞–ø—Ä–æ—Å –∫ —Å–ø–∏—Å–∫—É
        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists',
            IBLOCK_ID: lvl.listId,
            FILTER: filter,
            SELECT: ['ID', 'NAME']
        }, res => {
            el.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>';
            if(res.data()) {
                res.data().forEach(item => {
                    el.innerHTML += `<option value="${item.ID}">${item.NAME}</option>`;
                });
            }
            el.disabled = false;

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (lvl.val) {
                const exists = [...el.options].some(o => o.value == lvl.val);
                if (exists) {
                    el.value = lvl.val;
                    this.updateLink(idx, lvl.val);
                    // –ì—Ä—É–∑–∏–º —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
                    this.loadLevel(idx + 1, lvl.val);
                } else {
                    lvl.val = null; // –°–±—Ä–æ—Å, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ —Ñ–∏–ª—å—Ç—Ä—É
                }
            }
            
            // –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞ —Ñ—Ä–µ–π–º–∞
            const h = document.body.scrollHeight;
            BX24.placement.call('resizeWindow', { width: '100%', height: h + 20 });
        });
    },

    onChange: function(idx) {
        const val = document.getElementById(`sel-${idx}`).value;
        const lvl = this.levels[idx];
        
        this.updateLink(idx, val);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ CRM
        BX24.callMethod('crm.deal.update', {
            ID: this.entityId,
            FIELDS: { [lvl.crmField]: val }
        });

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏–∂–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å
        if (idx + 1 < this.levels.length) {
            this.loadLevel(idx + 1, val);
        }
    },

    updateLink: function(idx, recId) {
        const link = document.getElementById(`link-${idx}`);
        const listId = this.levels[idx].listId;
        if(recId && App.domain) {
            link.href = `https://${App.domain}/company/lists/${listId}/element/0/${recId}/`;
            link.style.display = 'flex';
        } else {
            link.style.display = 'none';
        }
    }
};

App.init();
</script>
</body>
</html>
