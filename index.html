<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ 1–°</title>
    <script src="https://api.bitrix24.com/api/v1/"></script>
    <style>
        body { margin: 0; padding: 0; background: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #app { padding: 15px; max-width: 600px; }
        
        .b24-field { margin-bottom: 15px; }
        .b24-label { font-size: 12px; color: #535c69; margin-bottom: 5px; display: block; font-weight: 600; text-transform: uppercase; }
        
        /* –ì—Ä—É–ø–ø–∞: –°–µ–ª–µ–∫—Ç + –ö–Ω–æ–ø–∫–∞ */
        .input-group { display: flex; gap: 10px; align-items: center; }
        
        .b24-select {
            flex-grow: 1; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç */
            display: block; height: 40px; padding: 0 10px;
            font-size: 15px; color: #333; background: #fff;
            border: 1px solid #c6cdd3; border-radius: 4px;
            box-sizing: border-box; outline: none;
        }
        .b24-select:disabled { background: #f9fafb; color: #aaa; cursor: not-allowed; }

        /* –ö–Ω–æ–ø–∫–∞ —Ñ–∞–π–ª–∞ */
        .btn-file {
            display: inline-flex; align-items: center; justify-content: center;
            height: 40px; padding: 0 15px;
            background: #fff; border: 1px solid #c6cdd3; border-radius: 4px;
            color: #535c69; text-decoration: none; font-size: 13px; font-weight: 600;
            white-space: nowrap; transition: 0.2s; cursor: pointer;
        }
        .btn-file:hover { background: #f0f2f5; border-color: #b0b8c0; }
        .btn-file.disabled { 
            opacity: 0.5; pointer-events: none; background: #f9fafb; border-color: #eee; color: #ccc; 
        }
        .btn-file span { margin-left: 5px; }

        /* –ö–Ω–æ–ø–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ */
        .btn-install {
            display: inline-block; padding: 12px 24px; background: #9dcf00; 
            color: #fff; text-decoration: none; border-radius: 4px; 
            font-weight: bold; cursor: pointer; border: none; font-size: 14px;
        }

        #ui-loader { text-align: center; color: #888; margin-top: 20px; }
        #install-screen, #main-screen { display: none; }
        #visual-log { 
            margin-top: 20px; padding: 10px; background: #000; color: #0f0; 
            font-family: monospace; font-size: 10px; border-radius: 4px;
            max-height: 200px; overflow-y: auto; word-break: break-all;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="ui-loader">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

    <div id="install-screen" style="text-align:center; padding-top: 20px;">
        <h3>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</h3>
        <p>–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω –≤–Ω—É—Ç—Ä–∏ –°–¥–µ–ª–∫–∏, –∑–Ω–∞—á–∏—Ç ID –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>
        <button class="btn-install" onclick="app.install()">–û–±–Ω–æ–≤–∏—Ç—å –≤—Å—Ç—Ä–æ–π–∫—É</button>
    </div>

    <div id="main-screen">
        <div class="b24-field">
            <label class="b24-label">–î–æ–≥–æ–≤–æ—Ä —Å –∫–ª–∏–µ–Ω—Ç–æ–º</label>
            <div class="input-group">
                <select id="select-dogovor" class="b24-select"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                <a id="btn-dogovor" class="btn-file disabled" target="_blank">üìÑ <span>–§–∞–π–ª</span></a>
            </div>
        </div>

        <div class="b24-field">
            <label class="b24-label">–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è</label>
            <div class="input-group">
                <select id="select-spec" class="b24-select" disabled><option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä</option></select>
                <a id="btn-spec" class="btn-file disabled" target="_blank">üìÑ <span>–§–∞–π–ª</span></a>
            </div>
        </div>

        <div class="b24-field">
            <label class="b24-label">–ó–∞–∫–∞–∑ –ö–ª–∏–µ–Ω—Ç–∞</label>
            <div class="input-group">
                <select id="select-order" class="b24-select" disabled><option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é</option></select>
                <a id="btn-order" class="btn-file disabled" target="_blank">üìÑ <span>–§–∞–π–ª</span></a>
            </div>
        </div>

        <div style="text-align: right; font-size: 11px; color: #999;">ID –°–¥–µ–ª–∫–∏: <span id="deal-id-display">...</span></div>
    </div>

    <div id="visual-log">Log started...</div>
</div>

<script>
function log(msg) {
    console.log(msg);
    const el = document.getElementById('visual-log');
    el.innerHTML = `> ${msg}<br>` + el.innerHTML;
}

const CONFIG = {
    LISTS: { DOGOVOR: 55, SPEC: 57, ORDER: 59 },
    PROPS: {
        LINK_TO_DOGOVOR: "PROPERTY_PROPERTY_PARENT_DOGOVOR", 
        LINK_TO_SPEC: "PROPERTY_PROPERTY_PARENT_SPECIFICATION", 
        
        DEAL_DOGOVOR: "UF_CRM_1766155842",
        DEAL_SPEC: "UF_CRM_1766155890",
        DEAL_ORDER: "UF_CRM_1766155959",

        // === –ö–û–î–´ –°–í–û–ô–°–¢–í –§–ê–ô–õ–û–í ===
        FILE_DOGOVOR: "PROPERTY_309",
        FILE_SPEC: "PROPERTY_313",
        FILE_ORDER: "PROPERTY_311"
    }
};

const app = {
    dealId: 0,
    domain: null, // –°—é–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏–º –∞–¥—Ä–µ—Å –ø–æ—Ä—Ç–∞–ª–∞ (riverclack.bitrix24.ru)
    started: false,

    init: function() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ–º–µ–Ω –∏–∑ URL –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫
        this.domain = urlParams.get('DOMAIN');
        if(!this.domain && document.referrer) {
             // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –∏–∑ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
             try { this.domain = new URL(document.referrer).hostname; } catch(e){}
        }

        let idFromUrl = urlParams.get('PLACEMENT_OPTIONS[ID]');
        if (!idFromUrl && urlParams.get('PLACEMENT_OPTIONS')) {
            try { 
                const opts = JSON.parse(urlParams.get('PLACEMENT_OPTIONS'));
                if (opts.ID) idFromUrl = opts.ID;
            } catch(e) {}
        }

        if (idFromUrl) {
            this.start(idFromUrl);
        } else {
            BX24.init(() => {
                // –ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –¥–æ–º–µ–Ω –±–µ—Ä–µ–º –æ—Ç—Ç—É–¥–∞
                this.domain = BX24.getAuth().domain; 
                BX24.placement.info((info) => {
                    if (info.placement === 'CRM_DEAL_DETAIL_TAB') {
                        this.start(info.options.ID);
                    } else {
                        this.showInstall();
                    }
                });
            });
            setTimeout(() => { if (!this.started) this.showInstall(); }, 2000);
        }
    },

    start: function(id) {
        if (this.started) return;
        this.started = true;
        this.dealId = id;
        
        document.getElementById('ui-loader').style.display = 'none';
        document.getElementById('install-screen').style.display = 'none';
        document.getElementById('main-screen').style.display = 'block';
        document.getElementById('deal-id-display').innerText = id;
        
        BX24.fitWindow();
        logic.loadDogovors();
        logic.syncWithDeal();
    },

    showInstall: function() {
        if (this.started) return;
        document.getElementById('ui-loader').style.display = 'none';
        document.getElementById('install-screen').style.display = 'block';
    },

    install: function() {
        const cleanUrl = window.location.protocol + "//" + window.location.host + "/";
        BX24.callMethod('placement.bind', {
            PLACEMENT: 'CRM_DEAL_DETAIL_TAB',
            HANDLER: cleanUrl,
            TITLE: '1C –°–ø–∏—Å–∫–∏'
        }, r => alert(r.error() ? "–û—à–∏–±–∫–∞: " + r.error() : "–£—Å–ø–µ—à–Ω–æ! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."));
    }
};

const logic = {
    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ ID –≠–ª–µ–º–µ–Ω—Ç–∞ -> ID –§–∞–π–ª–∞
    fileCache: {
        dogovor: {},
        spec: {},
        order: {}
    },

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID —Ñ–∞–π–ª–∞ –∏–∑ "—Å—Ç—Ä–∞–Ω–Ω–æ–≥–æ" —Ñ–æ—Ä–º–∞—Ç–∞ –ë–∏—Ç—Ä–∏–∫—Å–∞
    extractFileId: function(propValue) {
        if (!propValue) return null;
        // –ë–∏—Ç—Ä–∏–∫—Å —á–∞—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–π—Å—Ç–≤–∞ —Ç–∏–ø–∞ –§–∞–π–ª –∫–∞–∫ –æ–±—ä–µ–∫—Ç {"0": "123"} –∏–ª–∏ –º–∞—Å—Å–∏–≤ ["123"]
        if (typeof propValue === 'object') {
            return Object.values(propValue)[0];
        }
        return propValue;
    },

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Ñ–∞–π–ª–∞
    updateFileButton: function(btnId, selectId, cacheKey, iblockId, fieldIdNumeric) {
        const btn = document.getElementById(btnId);
        const selectedValue = document.getElementById(selectId).value;
        const fileId = this.fileCache[cacheKey][selectedValue];

        if (fileId && app.domain) {
            btn.classList.remove('disabled');
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–∑ –°–ø–∏—Å–∫–æ–≤
            // –§–æ—Ä–º–∞—Ç: /bitrix/components/bitrix/lists.element.edit/show_file.php?ib=IBLOCK_ID&id=ELEMENT_ID&field_id=FIELD_ID&file_id=FILE_ID
            const link = `https://${app.domain}/bitrix/components/bitrix/lists.element.edit/show_file.php?ib=${iblockId}&id=${selectedValue}&field_id=${fieldIdNumeric}&file_id=${fileId}`;
            btn.href = link;
        } else {
            btn.classList.add('disabled');
            btn.href = "javascript:void(0)";
        }
    },

    loadDogovors: function() {
        log("Loading Dogovors + Files...");
        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists', 
            IBLOCK_ID: CONFIG.LISTS.DOGOVOR, 
            SELECT: ['ID', 'NAME', CONFIG.PROPS.FILE_DOGOVOR] // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–µ —Ñ–∞–π–ª–∞
        }, res => {
            if(res.error()) return log("Err: " + res.error());
            
            let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä</option>';
            res.data().forEach(i => {
                html += `<option value="${i.ID}">${i.NAME}</option>`;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ñ–∞–π–ª–∞ –≤ –∫—ç—à
                this.fileCache.dogovor[i.ID] = this.extractFileId(i[CONFIG.PROPS.FILE_DOGOVOR]);
            });
            document.getElementById('select-dogovor').innerHTML = html;
        });
    },

    loadSpecs: function(parentId, selected = null) {
        const el = document.getElementById('select-spec');
        const elOrd = document.getElementById('select-order');
        el.innerHTML = '<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>'; el.disabled = true;
        elOrd.innerHTML = '<option>...</option>'; elOrd.disabled = true;
        
        // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫
        document.getElementById('btn-spec').classList.add('disabled');
        document.getElementById('btn-order').classList.add('disabled');

        if(!parentId) return;

        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists', 
            IBLOCK_ID: CONFIG.LISTS.SPEC,
            FILTER: { [CONFIG.PROPS.LINK_TO_DOGOVOR]: parentId }, 
            SELECT: ['ID', 'NAME', CONFIG.PROPS.FILE_SPEC] // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–µ —Ñ–∞–π–ª–∞
        }, res => {
            el.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é</option>';
            res.data().forEach(i => {
                el.innerHTML += `<option value="${i.ID}">${i.NAME}</option>`;
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
                this.fileCache.spec[i.ID] = this.extractFileId(i[CONFIG.PROPS.FILE_SPEC]);
            });
            el.disabled = false;
            
            if(selected) { 
                el.value = selected; 
                this.updateFileButton('btn-spec', 'select-spec', 'spec', CONFIG.LISTS.SPEC, '313'); // 313 –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                this.loadOrders(selected, logic.savedOrder); 
            }
        });
    },

    loadOrders: function(parentId, selected = null) {
        const el = document.getElementById('select-order');
        el.innerHTML = '<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>'; el.disabled = true;
        document.getElementById('btn-order').classList.add('disabled');

        if(!parentId) return;

        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists', 
            IBLOCK_ID: CONFIG.LISTS.ORDER,
            FILTER: { [CONFIG.PROPS.LINK_TO_SPEC]: parentId }, 
            SELECT: ['ID', 'NAME', CONFIG.PROPS.FILE_ORDER] // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–µ —Ñ–∞–π–ª–∞
        }, res => {
            el.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑</option>';
            res.data().forEach(i => {
                el.innerHTML += `<option value="${i.ID}">${i.NAME}</option>`;
                this.fileCache.order[i.ID] = this.extractFileId(i[CONFIG.PROPS.FILE_ORDER]);
            });
            el.disabled = false;
            if(selected) {
                el.value = selected;
                this.updateFileButton('btn-order', 'select-order', 'order', CONFIG.LISTS.ORDER, '311'); // 311 –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            }
        });
    },
    
    savedOrder: null,

    syncWithDeal: function() {
        BX24.callMethod('crm.deal.get', { ID: app.dealId }, res => {
            if(!res.data()) return;
            const data = res.data();
            const dogovorId = data[CONFIG.PROPS.DEAL_DOGOVOR];
            const specId = data[CONFIG.PROPS.DEAL_SPEC];
            this.savedOrder = data[CONFIG.PROPS.DEAL_ORDER];

            if(dogovorId) {
                const waiter = setInterval(() => {
                    const el = document.getElementById('select-dogovor');
                    if(el.options.length > 1) {
                        clearInterval(waiter);
                        el.value = dogovorId;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è
                        this.updateFileButton('btn-dogovor', 'select-dogovor', 'dogovor', CONFIG.LISTS.DOGOVOR, '309');
                        this.loadSpecs(dogovorId, specId);
                    }
                }, 100);
            }
        });
    },

    save: function() {
        BX24.callMethod('crm.deal.update', {
            ID: app.dealId,
            FIELDS: {
                [CONFIG.PROPS.DEAL_DOGOVOR]: document.getElementById('select-dogovor').value,
                [CONFIG.PROPS.DEAL_SPEC]: document.getElementById('select-spec').value,
                [CONFIG.PROPS.DEAL_ORDER]: document.getElementById('select-order').value
            }
        });
    }
};

// –°–æ–±—ã—Ç–∏—è: –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º—ã–µ —Å–ø–∏—Å–∫–∏ –ò –∫–Ω–æ–ø–∫—É —Ñ–∞–π–ª–∞
document.getElementById('select-dogovor').onchange = function() { 
    logic.updateFileButton('btn-dogovor', 'select-dogovor', 'dogovor', CONFIG.LISTS.DOGOVOR, '309');
    logic.loadSpecs(this.value); 
    logic.save(); 
};

document.getElementById('select-spec').onchange = function() { 
    logic.updateFileButton('btn-spec', 'select-spec', 'spec', CONFIG.LISTS.SPEC, '313');
    logic.loadOrders(this.value); 
    logic.save(); 
};

document.getElementById('select-order').onchange = function() { 
    logic.updateFileButton('btn-order', 'select-order', 'order', CONFIG.LISTS.ORDER, '311');
    logic.save(); 
};

app.init();
</script>
</body>
</html>
