<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ü–æ–ª–µ–π 1–° (Pro)</title>
    <script src="https://api.bitrix24.com/api/v1/"></script>
    <style>
        body { margin: 0; padding: 0; background: #fff; font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* === –≠–ö–†–ê–ù –ü–û–õ–Ø === */
        #field-screen { background: transparent; overflow: hidden; padding: 0; display: none; }
        
        .control-row { margin-bottom: 8px; }
        .b24-label { font-size: 11px; color: #80868e; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
        .input-group { display: flex; align-items: center; gap: 5px; }
        
        .b24-select {
            flex-grow: 1; height: 34px; padding: 0 8px; font-size: 14px; color: #333; background: #fff;
            border: 1px solid #c6cdd3; border-radius: 2px; box-sizing: border-box; outline: none;
        }
        .b24-select:focus { border-color: #2fc6f6; }
        .b24-select:disabled { background: #f4f4f4; color: #aaa; }
        
        .btn-link {
            display: none; align-items: center; justify-content: center;
            width: 34px; height: 34px; border: 1px solid #c6cdd3; border-radius: 2px;
            background: #fff; text-decoration: none; color: #555; font-size: 16px;
        }
        .btn-link:hover { background: #f0f2f5; color: #2fc6f6; }

        /* –§–æ–ª–±—ç–∫ —Å–µ–ª–µ–∫—Ç–æ—Ä (–µ—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–ª–∞—Å—å –∫–æ–Ω—Ñ–∏–≥–∞) */
        #fallback-selector { padding: 10px; background: #fff4e5; border: 1px solid #ffd591; border-radius: 4px; display: none; margin-bottom: 10px; }
        #fallback-selector p { margin: 0 0 5px 0; font-size: 12px; color: #d46b08; }

        /* === –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö === */
        #settings-screen { max-width: 900px; margin: 0 auto; padding: 20px; display: none; }
        .settings-card { background: #fff; border: 1px solid #edeef0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 30px; }
        
        .config-block { border: 2px solid #e0e2e4; border-radius: 6px; padding: 20px; margin-bottom: 30px; background: #fdfdfd; position: relative; }
        .config-header { display: flex; gap: 15px; margin-bottom: 15px; background: #f0f2f5; padding: 10px; border-radius: 4px; }
        .config-header .col { flex: 1; }
        .btn-remove-config { position: absolute; top: -10px; right: -10px; background: #ff5752; color: #fff; border: none; cursor: pointer; width: 24px; height: 24px; border-radius: 50%; font-weight: bold; line-height: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        table.config-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; background: #fff; }
        table.config-table th { text-align: left; background: #fff; padding: 5px; font-size: 10px; color: #999; border-bottom: 1px solid #ddd; }
        table.config-table td { padding: 5px; vertical-align: top; }
        table.config-table input { width: 100%; box-sizing: border-box; height: 30px; border: 1px solid #c6cdd3; border-radius: 3px; padding: 0 8px; font-size: 13px; }
        
        .form-label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 11px; color: #535c69; text-transform: uppercase; }
        .form-input { width: 100%; height: 36px; padding: 0 10px; border: 1px solid #c6cdd3; border-radius: 3px; box-sizing: border-box; }

        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .btn-success { background: #9dcf00; color: #fff; font-size: 16px; padding: 12px 24px; width: 100%; }
        .btn-new-field { background: #2fc6f6; color: #fff; width: 100%; margin-bottom: 30px; padding: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-add { background: #eef2f4; color: #333; border: 1px solid #c6cdd3; font-size: 12px; }
        .btn-del { background: #ffdede; color: #d00; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border-radius: 3px; }

        #debug-log { margin-top: 30px; padding: 15px; background: #222; color: #0f0; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; border-top: 5px solid #444; word-break: break-all; display: none; }
    </style>
</head>
<body>

<div id="loader-screen" style="text-align:center; padding: 20px; color: #888;">
    <h3>–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
</div>

<div id="settings-screen">
    <div class="settings-card">
        <h2 style="margin-top:0;">üß© –†–∞–∑–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è 1–°</h2>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">
            –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∞–Ω–µ—Ç <b>–æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–æ–ª–µ–º</b> –≤ –°–¥–µ–ª–∫–µ.
        </p>
        
        <div id="configs-container"></div>
        <button class="btn btn-new-field" onclick="Settings.addNewConfig()">+ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É (–Ω–æ–≤–æ–µ –ø–æ–ª–µ)</button>
        <button class="btn btn-success" onclick="Settings.save()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—è</button>
        <div id="save-log" style="margin-top:10px; font-size: 12px; color: #555;"></div>
    </div>
    <div id="debug-log"></div>
</div>

<div id="field-screen">
    <div id="fallback-selector">
        <p>‚ö†Ô∏è –≠—Ç–æ –ø–æ–ª–µ –ø–æ—Ç–µ—Ä—è–ª–æ —Å–≤—è–∑—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä—É—á–Ω—É—é, —á—Ç–æ –∑–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:</p>
        <select id="manual-group-select" class="b24-select" onchange="App.manualSelectGroup(this.value)">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
        </select>
    </div>

    <div id="field-render-area"></div>
    <div id="field-msg" style="color:#999; text-align:center; padding:10px;"></div>
</div>

<script>
function log(msg) {
    console.log(msg);
    const el = document.getElementById('debug-log');
    if(el && el.style.display !== 'none') el.innerHTML = `> ${msg}<br>` + el.innerHTML;
}
function saveLog(msg, color='black') {
    const el = document.getElementById('save-log');
    if(el) el.innerHTML += `<div style="color:${color}">${msg}</div>`;
}

const App = {
    config: null,
    domain: null,
    currentGroupId: null, // ID –≥—Ä—É–ø–ø—ã –∏–∑ URL

    init: function() {
        const params = new URLSearchParams(window.location.search);
        const placement = params.get('PLACEMENT');
        const isFieldMode = (placement === 'USERFIELD_TYPE');
        this.currentGroupId = params.get('group_id'); 
        
        let placementOptions = null;
        try {
            const rawOpts = params.get('PLACEMENT_OPTIONS');
            if (rawOpts) placementOptions = JSON.parse(rawOpts);
        } catch(e) {}

        BX24.init(() => {
            this.domain = BX24.getAuth().domain;
            
            this.loadConfig((loadedConfig) => {
                this.config = loadedConfig;

                if (isFieldMode) {
                    if (placementOptions && placementOptions.ENTITY_ID) {
                        this.renderFieldMode(placementOptions.ENTITY_ID);
                    } else {
                        BX24.placement.info((info) => {
                            this.renderFieldMode(info.options.ENTITY_ID);
                        });
                    }
                } else {
                    this.renderSettingsMode();
                }
            });
        });
    },

    loadConfig: function(callback) {
        // –ò–°–ü–û–õ–¨–ó–£–ï–ú v5 –ß–¢–û–ë–´ –ù–ê–ß–ê–¢–¨ –° –ß–ò–°–¢–û–ì–û –õ–ò–°–¢–ê
        BX24.callMethod('app.option.get', { option: 'riverclack_config_v5' }, (res) => {
            let data = res.data();
            if (!data) {
                // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
                callback({ groups: [{
                    id: "grp_" + Math.floor(Math.random() * 10000),
                    title: "1–°: –î–æ–≥–æ–≤–æ—Ä—ã",
                    levels: [{ name: "–î–æ–≥–æ–≤–æ—Ä", listId: "55", linkProp: "", crmField: "UF_CRM_1766155842" }]
                }]});
                return;
            }
            callback(data);
        });
    },

    renderSettingsMode: function() {
        document.getElementById('loader-screen').style.display = 'none';
        document.getElementById('settings-screen').style.display = 'block';
        document.getElementById('debug-log').style.display = 'block';

        const container = document.getElementById('configs-container');
        container.innerHTML = '';
        (this.config.groups || []).forEach(grp => Settings.renderConfigBlock(grp));
    },

    renderFieldMode: function(entityId) {
        document.getElementById('loader-screen').style.display = 'none';
        document.getElementById('field-screen').style.display = 'block';
        
        // 1. –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É –ø–æ ID –∏–∑ URL
        let targetGroup = null;
        if (this.currentGroupId) {
            targetGroup = this.config.groups.find(g => g.id === this.currentGroupId);
        }

        // 2. –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–∞–π–¥–µ–Ω–∞ - –∑–∞–ø—É—Å–∫–∞–µ–º
        if (targetGroup) {
            FieldLogic.start(entityId, targetGroup.levels);
            return;
        }

        // 3. –ï–°–õ–ò –ì–†–£–ü–ü–ê –ù–ï –ù–ê–ô–î–ï–ù–ê (–°–ë–û–ô –ò–õ–ò –£–î–ê–õ–ï–ù–ò–ï)
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ê–≤–∞—Ä–∏–π–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä"
        const selector = document.getElementById('manual-group-select');
        const container = document.getElementById('fallback-selector');
        
        container.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –≤—ã–±–æ—Ä–∞
        
        this.config.groups.forEach(g => {
            selector.innerHTML += `<option value="${g.id}">${g.title}</option>`;
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        this.tempEntityId = entityId;
        
        // –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞, —á—Ç–æ–±—ã —Å–µ–ª–µ–∫—Ç–æ—Ä –≤–ª–µ–∑
        BX24.placement.call('resizeWindow', { width: '100%', height: 150 });
    },
    
    // –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞)
    manualSelectGroup: function(groupId) {
        if(!groupId) return;
        const targetGroup = this.config.groups.find(g => g.id === groupId);
        if(targetGroup) {
            document.getElementById('fallback-selector').style.display = 'none';
            FieldLogic.start(this.tempEntityId, targetGroup.levels);
        }
    }
};

const Settings = {
    renderConfigBlock: function(data = {}) {
        const container = document.getElementById('configs-container');
        const div = document.createElement('div');
        div.className = 'config-block';
        
        if (!data.id) data.id = "grp_" + Math.floor(Math.random() * 100000);

        div.innerHTML = `
            <button class="btn-remove-config" onclick="this.closest('.config-block').remove()" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
            <div class="config-header">
                <div class="col">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è (–≤ —Å–ø–∏—Å–∫–µ –ø–æ–ª–µ–π CRM):</label>
                    <input type="text" class="inp-title form-input" value="${data.title || ''}" placeholder="–ù–∞–ø—Ä: 1–° –°–Ω–∞–±–∂–µ–Ω–∏–µ">
                </div>
                <div class="col">
                    <label class="form-label">System ID:</label>
                    <input type="text" class="inp-id form-input" value="${data.id}" readonly style="background:#f9f9f9; color:#777;">
                </div>
            </div>
            <table class="config-table">
                <thead><tr><th width="20%">–ò–º—è</th><th width="10%">ID –°–ø–∏—Å–∫–∞</th><th width="25%">–°–≤—è–∑—å (–ö–æ–¥)</th><th width="25%">CRM –ü–æ–ª–µ</th><th width="5%"></th></tr></thead>
                <tbody class="levels-tbody"></tbody>
            </table>
            <button class="btn btn-add" onclick="Settings.addLevelRow(this)">+ –£—Ä–æ–≤–µ–Ω—å</button>
        `;
        container.appendChild(div);

        const tbody = div.querySelector('.levels-tbody');
        (data.levels || []).forEach(lvl => this.appendLevelRow(tbody, lvl));
    },

    addNewConfig: function() {
        this.renderConfigBlock({ title: "–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ –ø–æ–ª–µ–π", levels: [] });
    },

    addLevelRow: function(btn) {
        this.appendLevelRow(btn.closest('.config-block').querySelector('.levels-tbody'), {});
    },

    appendLevelRow: function(tbody, data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="inp-name" value="${data.name || ''}"></td>
            <td><input type="text" class="inp-list" value="${data.listId || ''}"></td>
            <td><input type="text" class="inp-link" value="${data.linkProp || ''}"></td>
            <td><input type="text" class="inp-crm" value="${data.crmField || ''}"></td>
            <td><button class="btn btn-del" onclick="this.closest('tr').remove()">√ó</button></td>
        `;
        tbody.appendChild(tr);
    },

    save: function() {
        const logEl = document.getElementById('save-log');
        logEl.innerHTML = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        
        const newConfig = { groups: [] };
        const activeIds = [];

        document.querySelectorAll('.config-block').forEach(block => {
            const grp = {
                title: block.querySelector('.inp-title').value,
                id: block.querySelector('.inp-id').value,
                levels: []
            };
            activeIds.push('riverclack_' + grp.id); // ID –¥–ª—è –ë–∏—Ç—Ä–∏–∫—Å–∞
            
            block.querySelectorAll('tbody tr').forEach(tr => {
                grp.levels.push({
                    name: tr.querySelector('.inp-name').value,
                    listId: tr.querySelector('.inp-list').value,
                    linkProp: tr.querySelector('.inp-link').value,
                    crmField: tr.querySelector('.inp-crm').value
                });
            });
            newConfig.groups.push(grp);
        });

        // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ v5
        BX24.callMethod('app.option.set', { options: { riverclack_config_v5: newConfig } }, (res) => {
            if(res.error()) {
                saveLog("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + res.error(), "red");
                return;
            }
            saveLog("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.", "green");
            
            // 2. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ/—É–¥–∞–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è
            BX24.callMethod('userfieldtype.list', {}, (listRes) => {
                if(listRes.data()) {
                    listRes.data().forEach(type => {
                        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞—à–µ –ø–æ–ª–µ (riverclack_), –Ω–æ –µ–≥–æ –Ω–µ—Ç –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ñ–∏–≥–µ -> –£–î–ê–õ–Ø–ï–ú
                        if(type.USER_TYPE_ID.startsWith('riverclack_') && !activeIds.includes(type.USER_TYPE_ID)) {
                            saveLog(`–£–¥–∞–ª—è—é —Å—Ç–∞—Ä—ã–π —Ç–∏–ø –ø–æ–ª—è: ${type.DESCRIPTION}...`, "orange");
                            BX24.callMethod('userfieldtype.delete', { USER_TYPE_ID: type.USER_TYPE_ID });
                        }
                    });
                }

                // 3. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
                const baseUrl = window.location.href.split('?')[0];

                newConfig.groups.forEach(grp => {
                    const handlerUrl = baseUrl + "?group_id=" + grp.id;
                    const userTypeId = 'riverclack_' + grp.id; 

                    BX24.callMethod('userfieldtype.add', {
                        USER_TYPE_ID: userTypeId, 
                        HANDLER: handlerUrl,
                        TITLE: grp.title,
                        DESCRIPTION: 'App Field: ' + grp.title
                    }, (res2) => {
                        if (res2.error() && !res2.error().toString().includes("binded")) {
                             saveLog(`–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ "${grp.title}": ${res2.error()}`, "red");
                        } else {
                            saveLog(`–ü–æ–ª–µ "${grp.title}" –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!`, "blue");
                        }
                    });
                });
            });
        });
    }
};

const FieldLogic = {
    entityId: 0,
    levels: [],

    start: function(id, levels) {
        this.entityId = parseInt(id) || 0;
        this.levels = levels;
        
        const container = document.getElementById('field-render-area');
        container.innerHTML = '';
        
        this.levels.forEach((lvl, idx) => {
            const row = document.createElement('div');
            row.className = 'control-row';
            row.innerHTML = `
                <div class="b24-label">${lvl.name}</div>
                <div class="input-group">
                    <select id="sel-${idx}" class="b24-select" disabled><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                    <a id="link-${idx}" class="btn-link" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å">üîó</a>
                </div>
            `;
            container.appendChild(row);
            document.getElementById(`sel-${idx}`).onchange = () => this.onChange(idx);
        });

        if (this.entityId === 0) {
            document.getElementById('field-msg').innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–¥–µ–ª–∫—É";
            this.loadLevel(0, null);
            return;
        }

        this.sync();
    },

    sync: function() {
        BX24.callMethod('crm.deal.get', { ID: this.entityId }, res => {
            if(!res.data()) return;
            const data = res.data();
            this.levels.forEach(lvl => { lvl.val = data[lvl.crmField]; });
            this.loadLevel(0, null);
        });
    },

    loadLevel: function(idx, parentVal) {
        if(idx >= this.levels.length) return;
        const lvl = this.levels[idx];
        const el = document.getElementById(`sel-${idx}`);
        
        for(let i = idx; i < this.levels.length; i++) {
            const n = document.getElementById(`sel-${i}`);
            n.innerHTML = '<option value="">' + (i === idx ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '...') + '</option>';
            n.disabled = true;
            document.getElementById(`link-${i}`).style.display = 'none';
        }

        const filter = {};
        if (idx > 0) {
            if (!parentVal) {
                el.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—ã—à–µ</option>';
                return;
            }
            filter[lvl.linkProp] = parentVal;
        }

        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists',
            IBLOCK_ID: lvl.listId,
            FILTER: filter,
            SELECT: ['ID', 'NAME']
        }, res => {
            el.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>';
            if(res.data()) {
                res.data().forEach(item => {
                    el.innerHTML += `<option value="${item.ID}">${item.NAME}</option>`;
                });
            }
            el.disabled = false;

            if (lvl.val) {
                const exists = [...el.options].some(o => o.value == lvl.val);
                if (exists) {
                    el.value = lvl.val;
                    this.updateLink(idx, lvl.val);
                    this.loadLevel(idx + 1, lvl.val);
                } else {
                    lvl.val = null;
                }
            }
            
            // –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞
            const h = document.body.scrollHeight;
            BX24.placement.call('resizeWindow', { width: '100%', height: h + 20 });
        });
    },

    onChange: function(idx) {
        const val = document.getElementById(`sel-${idx}`).value;
        const lvl = this.levels[idx];
        this.updateLink(idx, val);
        
        if (this.entityId > 0) {
            BX24.callMethod('crm.deal.update', {
                ID: this.entityId,
                FIELDS: { [lvl.crmField]: val }
            });
        }

        if (idx + 1 < this.levels.length) {
            this.loadLevel(idx + 1, val);
        }
    },

    updateLink: function(idx, recId) {
        const link = document.getElementById(`link-${idx}`);
        const listId = this.levels[idx].listId;
        if(recId && App.domain) {
            link.href = `https://${App.domain}/company/lists/${listId}/element/0/${recId}/`;
            link.style.display = 'flex';
        } else {
            link.style.display = 'none';
        }
    }
};

App.init();
</script>
</body>
</html>
