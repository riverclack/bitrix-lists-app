<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ 1–°</title>

<script src="https://api.bitrix24.com/api/v1/"></script>
<script src="https://bitrix24.net/bitrix/js/ui/viewer.js"></script>
<link rel="stylesheet" href="https://bitrix24.net/bitrix/js/ui/viewer.css">

<style>
body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    background: #fff;
}
#app { padding: 15px; max-width: 700px; }
.field { margin-bottom: 18px; }
label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: #535c69;
    margin-bottom: 6px;
    text-transform: uppercase;
}
select {
    width: 100%;
    height: 38px;
    border: 1px solid #c6cdd3;
    border-radius: 4px;
    padding: 0 10px;
}
select:disabled { background: #f9fafb; color: #999; }

.files {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}
.btn {
    padding: 6px 12px;
    border-radius: 14px;
    border: 1px solid #c6cdd3;
    background: #f0f2f5;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    color: #333;
}
.btn:hover { background: #e8ecef; }
.link { color: #2fc6f6; border-color: transparent; }
</style>
</head>

<body>
<div id="app">
    <div class="field">
        <label>–î–æ–≥–æ–≤–æ—Ä</label>
        <select id="dogovor"><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
        <div class="files" id="files-dogovor"></div>
    </div>

    <div class="field">
        <label>–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è</label>
        <select id="spec" disabled><option>–°–Ω–∞—á–∞–ª–∞ –¥–æ–≥–æ–≤–æ—Ä</option></select>
        <div class="files" id="files-spec"></div>
    </div>

    <div class="field">
        <label>–ó–∞–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞</label>
        <select id="order" disabled><option>–°–Ω–∞—á–∞–ª–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è</option></select>
        <div class="files" id="files-order"></div>
    </div>
</div>

<script>
const CFG = {
    LISTS: { DOG:55, SPEC:57, ORD:59 },
    PROPS: {
        SPEC_PARENT: "PROPERTY_PROPERTY_PARENT_DOGOVOR",
        ORD_PARENT:  "PROPERTY_PROPERTY_PARENT_SPECIFICATION",
        DEAL_DOG: "UF_CRM_1766155842",
        DEAL_SPEC:"UF_CRM_1766155890",
        DEAL_ORD: "UF_CRM_1766155959",
        FILES: { DOG:309, SPEC:313, ORD:311 }
    }
};

let dealId = 0, domain = "";

BX24.init(() => {
    BX24.fitWindow();
    BX24.placement.info(info => {
        dealId = info.options.ID;
        domain = BX24.getAuth().domain;
        loadDogovors();
        syncDeal();
    });
});

function loadDogovors() {
    BX24.callMethod("lists.element.get", {
        IBLOCK_TYPE_ID:"lists",
        IBLOCK_ID:CFG.LISTS.DOG,
        SELECT:["ID","NAME"]
    }, r => {
        const s = document.getElementById("dogovor");
        s.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä</option>';
        r.data().forEach(i => s.innerHTML += `<option value="${i.ID}">${i.NAME}</option>`);
    });
}

function loadSpecs(dogId) {
    const s = document.getElementById("spec");
    s.disabled = true;
    s.innerHTML = "<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>";
    clearFiles("spec","order");

    BX24.callMethod("lists.element.get", {
        IBLOCK_TYPE_ID:"lists",
        IBLOCK_ID:CFG.LISTS.SPEC,
        FILTER:{ [CFG.PROPS.SPEC_PARENT]: dogId },
        SELECT:["ID","NAME"]
    }, r => {
        s.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é</option>';
        r.data().forEach(i => s.innerHTML += `<option value="${i.ID}">${i.NAME}</option>`);
        s.disabled = false;
    });
}

function loadOrders(specId) {
    const s = document.getElementById("order");
    s.disabled = true;
    s.innerHTML = "<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>";
    clearFiles("order");

    BX24.callMethod("lists.element.get", {
        IBLOCK_TYPE_ID:"lists",
        IBLOCK_ID:CFG.LISTS.ORD,
        FILTER:{ [CFG.PROPS.ORD_PARENT]: specId },
        SELECT:["ID","NAME"]
    }, r => {
        s.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑</option>';
        r.data().forEach(i => s.innerHTML += `<option value="${i.ID}">${i.NAME}</option>`);
        s.disabled = false;
    });
}

function files(container, iblock, elId, field) {
    const box = document.getElementById("files-"+container);
    box.innerHTML = "";

    if(!elId) return;

    const open = document.createElement("a");
    open.className = "btn link";
    open.href = `https://${domain}/company/lists/${iblock}/element/0/${elId}/`;
    open.target = "_blank";
    open.innerText = "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ‚Üó";
    box.appendChild(open);

    BX24.callMethod("lists.element.get.file.url", {
        IBLOCK_TYPE_ID:"lists",
        IBLOCK_ID:iblock,
        ELEMENT_ID:elId,
        FIELD_ID:field
    }, r => {
        r.data().forEach((url,i) => {
            const view = document.createElement("span");
            view.className = "btn";
            view.innerText = "üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä";
            view.onclick = () => BX.UI.Viewer.open({source:url});

            const down = document.createElement("a");
            down.className = "btn";
            down.href = url;
            down.target = "_blank";
            down.innerText = "üìÑ –°–∫–∞—á–∞—Ç—å";

            box.appendChild(view);
            box.appendChild(down);
        });
        BX24.fitWindow();
    });
}

function save() {
    BX24.callMethod("crm.deal.update", {
        ID:dealId,
        FIELDS:{
            [CFG.PROPS.DEAL_DOG]: dogovor.value,
            [CFG.PROPS.DEAL_SPEC]: spec.value,
            [CFG.PROPS.DEAL_ORD]: order.value
        }
    });
}

function clearFiles(...ids) {
    ids.forEach(i => document.getElementById("files-"+i).innerHTML = "");
}

dogovor.onchange = () => {
    files("dogovor",CFG.LISTS.DOG,dogovor.value,CFG.PROPS.FILES.DOG);
    loadSpecs(dogovor.value);
    save();
};

spec.onchange = () => {
    files("spec",CFG.LISTS.SPEC,spec.value,CFG.PROPS.FILES.SPEC);
    loadOrders(spec.value);
    save();
};

order.onchange = () => {
    files("order",CFG.LISTS.ORD,order.value,CFG.PROPS.FILES.ORD);
    save();
};

function syncDeal() {
    BX24.callMethod("crm.deal.get",{ID:dealId},r=>{
        const d=r.data();
        if(d[CFG.PROPS.DEAL_DOG]) {
            dogovor.value=d[CFG.PROPS.DEAL_DOG];
            files("dogovor",CFG.LISTS.DOG,d[CFG.PROPS.DEAL_DOG],CFG.PROPS.FILES.DOG);
            loadSpecs(d[CFG.PROPS.DEAL_DOG]);
        }
    });
}
</script>
</body>
</html>
