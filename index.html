<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–º–Ω—ã–µ –°–ø–∏—Å–∫–∏ 1–°</title>
    <script src="https://api.bitrix24.com/api/v1/"></script>
    <style>
        body { margin: 0; padding: 0; background: #fff; font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* === –°–¢–ò–õ–ò –î–õ–Ø –†–ï–ñ–ò–ú–ê –ü–û–õ–Ø (–í–°–¢–†–û–ô–ö–ê) === */
        .field-mode { background: transparent; overflow: hidden; padding: 0; }
        .field-mode .control-row { margin-bottom: 8px; }
        .field-mode .b24-label { font-size: 11px; color: #80868e; font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
        .field-mode .input-group { display: flex; align-items: center; gap: 5px; }
        .field-mode .b24-select {
            flex-grow: 1; height: 34px; padding: 0 8px; font-size: 14px; color: #333; background: #fff;
            border: 1px solid #c6cdd3; border-radius: 2px; box-sizing: border-box; outline: none;
        }
        .field-mode .b24-select:focus { border-color: #2fc6f6; }
        .field-mode .b24-select:disabled { background: #f4f4f4; color: #aaa; }
        .field-mode .btn-link {
            display: none; align-items: center; justify-content: center;
            width: 34px; height: 34px; border: 1px solid #c6cdd3; border-radius: 2px;
            background: #fff; text-decoration: none; color: #555; font-size: 16px;
        }
        .field-mode .btn-link:hover { background: #f0f2f5; color: #2fc6f6; }

        /* === –°–¢–ò–õ–ò –î–õ–Ø –†–ï–ñ–ò–ú–ê –ù–ê–°–¢–†–û–ï–ö === */
        .settings-mode { max-width: 800px; margin: 0 auto; padding: 20px; }
        .settings-card { background: #fff; border: 1px solid #edeef0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; font-size: 18px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #535c69; }
        .form-input, .form-select { width: 100%; height: 36px; padding: 0 10px; border: 1px solid #c6cdd3; border-radius: 3px; box-sizing: border-box; }
        
        /* –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π */
        .levels-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .levels-table th { text-align: left; font-size: 12px; color: #999; padding: 5px; border-bottom: 1px solid #eee; }
        .levels-table td { padding: 5px; vertical-align: top; }
        .levels-table input { width: 100%; height: 32px; border: 1px solid #ddd; padding: 0 5px; box-sizing: border-box; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: #2fc6f6; color: #fff; }
        .btn-primary:hover { background: #1db5e5; }
        .btn-add { background: #bbed21; color: #535c69; font-size: 12px; padding: 5px 10px; }
        .btn-del { background: #ff5752; color: #fff; width: 30px; height: 32px; display: flex; align-items: center; justify-content: center; }

        #screens > div { display: none; }
    </style>
</head>
<body>

<div id="screens">
    
    <div id="loader-screen" style="display:block; text-align:center; padding-top: 50px; color: #888;">
        –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...
    </div>

    <div id="settings-screen" class="settings-mode">
        <div class="settings-card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
            <p style="font-size: 13px; color: #888;">–ó–¥–µ—Å—å –≤—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç–µ —Å–≤—è–∑—å —Å–ø–∏—Å–∫–æ–≤ 1–° –∏ –ø–æ–ª–µ–π CRM.</p>
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è –≤ CRM</label>
                <input type="text" id="conf-title" class="form-input" value="1–° –ü—É–ª—å—Ç">
            </div>

            <div class="form-group">
                <label class="form-label">–°—É—â–Ω–æ—Å—Ç—å CRM</label>
                <select id="conf-entity" class="form-select">
                    <option value="CRM_DEAL">–°–¥–µ–ª–∫–∞ (CRM_DEAL)</option>
                    <option value="CRM_LEAD">–õ–∏–¥ (CRM_LEAD)</option>
                    <option value="CRM_COMPANY">–ö–æ–º–ø–∞–Ω–∏—è (CRM_COMPANY)</option>
                    <option value="CRM_CONTACT">–ö–æ–Ω—Ç–∞–∫—Ç (CRM_CONTACT)</option>
                    </select>
            </div>

            <div class="form-group">
                <label class="form-label">–¶–µ–ø–æ—á–∫–∞ –∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–ø–∏—Å–∫–æ–≤</label>
                <table class="levels-table">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="20%">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è</th>
                            <th width="15%">ID –°–ø–∏—Å–∫–∞</th>
                            <th width="25%">–ö–æ–¥ –ø–æ–ª—è —Å–≤—è–∑–∏ (–≤ —Å–ø–∏—Å–∫–µ)</th>
                            <th width="25%">–ö–æ–¥ –ø–æ–ª—è CRM (–∫—É–¥–∞ –ø–∏—Å–∞—Ç—å)</th>
                            <th width="10%"></th>
                        </tr>
                    </thead>
                    <tbody id="levels-container">
                        </tbody>
                </table>
                <br>
                <button class="btn btn-add" onclick="settings.addLevelRow()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            
            <button class="btn btn-primary" onclick="settings.saveAndInstall()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ</button>
            <span id="save-status" style="margin-left: 10px; color: green; font-weight: bold;"></span>
        </div>
    </div>

    <div id="field-screen" class="field-mode">
        <div id="dynamic-controls"></div>
        <div style="text-align: center; color: #999; margin-top: 20px;" id="field-loader">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </div>

</div>

<script>
// --- –ì–õ–û–ë–ê–õ–¨–ù–´–ô –û–ë–™–ï–ö–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
const App = {
    config: null,
    domain: null,
    
    init: function() {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–º–µ–Ω (–≤–∞–∂–Ω–æ –¥–ª—è —Å—Å—ã–ª–æ–∫)
        const params = new URLSearchParams(window.location.search);
        this.domain = params.get('DOMAIN');
        if(!this.domain && document.referrer) {
             try { this.domain = new URL(document.referrer).hostname; } catch(e){}
        }

        BX24.init(() => {
            if(!this.domain) this.domain = BX24.getAuth().domain;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            BX24.callMethod('app.option.get', { option: 'riverclack_config' }, (res) => {
                if(res.data()) {
                    this.config = res.data();
                } else {
                    // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø—Ä–∏–º–µ—Ä)
                    this.config = {
                        title: "1–° –ü—É–ª—å—Ç",
                        entity: "CRM_DEAL",
                        levels: [
                            { name: "–î–æ–≥–æ–≤–æ—Ä", listId: "55", linkProp: "", crmField: "UF_CRM_1766155842" },
                            { name: "–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è", listId: "57", linkProp: "PROPERTY_PROPERTY_PARENT_DOGOVOR", crmField: "UF_CRM_1766155890" },
                            { name: "–ó–∞–∫–∞–∑", listId: "59", linkProp: "PROPERTY_PROPERTY_PARENT_SPECIFICATION", crmField: "UF_CRM_1766155959" }
                        ]
                    };
                }

                this.route();
            });
        });
    },

    // –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è: –ü–æ–ª–µ –∏–ª–∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏?
    route: function() {
        const params = new URLSearchParams(window.location.search);
        const placementOptions = params.get('PLACEMENT_OPTIONS');
        
        document.getElementById('loader-screen').style.display = 'none';

        if (placementOptions) {
            // –ú–´ –í–ù–£–¢–†–ò –ü–û–õ–Ø
            try {
                const options = JSON.parse(placementOptions);
                document.getElementById('field-screen').style.display = 'block';
                FieldLogic.start(options.ENTITY_ID);
            } catch(e) { console.error(e); }
        } else {
            // –ú–´ –í –ê–î–ú–ò–ù–ö–ï
            document.getElementById('settings-screen').style.display = 'block';
            SettingsLogic.renderForm();
        }
    }
};

// --- –õ–û–ì–ò–ö–ê –ù–ê–°–¢–†–û–ï–ö ---
const SettingsLogic = {
    renderForm: function() {
        document.getElementById('conf-title').value = App.config.title || "1C –ü—É–ª—å—Ç";
        document.getElementById('conf-entity').value = App.config.entity || "CRM_DEAL";
        
        const container = document.getElementById('levels-container');
        container.innerHTML = '';
        
        (App.config.levels || []).forEach(lvl => {
            this.addLevelRow(lvl);
        });
    },

    addLevelRow: function(data = {}) {
        const container = document.getElementById('levels-container');
        const index = container.children.length;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${index + 1}</td>
            <td><input type="text" class="lvl-name" value="${data.name || ''}" placeholder="–ù–∞–ø—Ä. –î–æ–≥–æ–≤–æ—Ä"></td>
            <td><input type="text" class="lvl-list" value="${data.listId || ''}" placeholder="ID (55)"></td>
            <td><input type="text" class="lvl-link" value="${data.linkProp || ''}" placeholder="${index===0 ? '---' : 'PROPERTY_...'}"></td>
            <td><input type="text" class="lvl-crm" value="${data.crmField || ''}" placeholder="UF_CRM_..."></td>
            <td><button class="btn btn-del" onclick="this.closest('tr').remove()">√ó</button></td>
        `;
        container.appendChild(tr);
    },

    saveAndInstall: function() {
        const btn = document.querySelector('.btn-primary');
        const status = document.getElementById('save-status');
        btn.disabled = true;
        status.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

        // 1. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const newConfig = {
            title: document.getElementById('conf-title').value,
            entity: document.getElementById('conf-entity').value,
            levels: []
        };

        document.querySelectorAll('#levels-container tr').forEach(tr => {
            newConfig.levels.push({
                name: tr.querySelector('.lvl-name').value,
                listId: tr.querySelector('.lvl-list').value,
                linkProp: tr.querySelector('.lvl-link').value,
                crmField: tr.querySelector('.lvl-crm').value
            });
        });

        // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ AppOption
        BX24.callMethod('app.option.set', { options: { riverclack_config: newConfig } }, () => {
            // 3. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç–∏–ø –ø–æ–ª—è
            const handlerUrl = window.location.href.split('?')[0];
            BX24.callMethod('userfieldtype.add', {
                USER_TYPE_ID: 'riverclack_dynamic_v1', // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç–∏–ø–∞ –ø–æ–ª—è
                HANDLER: handlerUrl,
                TITLE: newConfig.title,
                DESCRIPTION: '–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å–ø–∏—Å–∫–∏ 1–°'
            }, (res) => {
                btn.disabled = false;
                if(res.error()) {
                    alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—è: " + res.error());
                    status.innerText = "–û—à–∏–±–∫–∞!";
                } else {
                    alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –ü–æ–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.");
                    status.innerText = "–£—Å–ø–µ—à–Ω–æ!";
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
                    App.config = newConfig;
                }
            });
        });
    }
};

// --- –õ–û–ì–ò–ö–ê –ü–û–õ–Ø (RUNTIME) ---
const FieldLogic = {
    dealId: 0,
    levels: [], // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–ø–∏—è —É—Ä–æ–≤–Ω–µ–π –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

    start: function(id) {
        this.dealId = id;
        this.levels = App.config.levels;
        
        // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
        const container = document.getElementById('dynamic-controls');
        container.innerHTML = '';

        this.levels.forEach((lvl, idx) => {
            const row = document.createElement('div');
            row.className = 'control-row';
            row.innerHTML = `
                <div class="b24-label">${lvl.name}</div>
                <div class="input-group">
                    <select id="select-lvl-${idx}" class="b24-select" disabled>
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>
                    <a id="link-lvl-${idx}" class="btn-link" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ">üîó</a>
                </div>
            `;
            container.appendChild(row);

            // –í–µ—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            document.getElementById(`select-lvl-${idx}`).onchange = () => {
                this.onChangeLevel(idx);
            };
        });

        // 2. –ï—Å–ª–∏ —Å–¥–µ–ª–∫–∞ –Ω–æ–≤–∞—è, –∂–¥–µ–º
        if(this.dealId == 0) {
            document.getElementById('field-loader').innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã.";
            return;
        }

        document.getElementById('field-loader').style.display = 'none';
        
        // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π –∏–∑ CRM
        this.syncWithEntity();
    },

    syncWithEntity: function() {
        // –ö–∞–∫–∏–µ –ø–æ–ª—è –Ω–∞–º –Ω—É–∂–Ω–æ –¥–æ—Å—Ç–∞—Ç—å –∏–∑ —Å–¥–µ–ª–∫–∏?
        const selectFields = this.levels.map(l => l.crmField);
        
        // –ó–∞–ø—Ä–æ—Å –∫ CRM (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ crm.item.get –∏–ª–∏ crm.deal.get)
        // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø–æ–∫–∞ –±–µ—Ä–µ–º crm.deal.get, –Ω–æ –º–æ–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ entity
        const method = App.config.entity === 'CRM_LEAD' ? 'crm.lead.get' : 'crm.deal.get';

        BX24.callMethod(method, { ID: this.dealId }, res => {
            if(!res.data()) return;
            const data = res.data();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç—å —É—Ä–æ–≤–Ω–µ–π
            this.levels.forEach(lvl => {
                lvl.currentValue = data[lvl.crmField];
            });

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–µ–ø–æ—á–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ —Å 0-–≥–æ —É—Ä–æ–≤–Ω—è
            this.loadLevel(0, null);
        });
    },

    loadLevel: function(levelIdx, parentValue) {
        if(levelIdx >= this.levels.length) return;

        const lvl = this.levels[levelIdx];
        const el = document.getElementById(`select-lvl-${levelIdx}`);
        const link = document.getElementById(`link-lvl-${levelIdx}`);

        // –û—á–∏—Å—Ç–∫–∞ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–≥–æ
        for(let i = levelIdx; i < this.levels.length; i++) {
            const nextEl = document.getElementById(`select-lvl-${i}`);
            nextEl.innerHTML = '<option value="">' + (i === levelIdx ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '...') + '</option>';
            nextEl.disabled = true;
            document.getElementById(`link-lvl-${i}`).style.display = 'none';
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä
        const filter = {};
        if (levelIdx > 0) {
            if (!parentValue) {
                el.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—à–µ</option>';
                return; 
            }
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ–π—Å—Ç–≤–æ —Å–≤—è–∑–∏, –∑–∞–¥–∞–Ω–Ω–æ–µ –≤ –∫–æ–Ω—Ñ–∏–≥–µ
            filter[lvl.linkProp] = parentValue;
        }

        // –ó–∞–ø—Ä–æ—Å –∫ —Å–ø–∏—Å–∫–∞–º
        BX24.callMethod('lists.element.get', {
            IBLOCK_TYPE_ID: 'lists',
            IBLOCK_ID: lvl.listId,
            FILTER: filter,
            SELECT: ['ID', 'NAME']
        }, res => {
            el.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
            
            if(res.data()) {
                res.data().forEach(item => {
                    el.innerHTML += `<option value="${item.ID}">${item.NAME}</option>`;
                });
            }
            
            el.disabled = false;

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —Å–¥–µ–ª–∫–µ
            if (lvl.currentValue) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ (–≤–∞–∂–Ω–æ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–æ–¥–∏—Ç–µ–ª—è)
                const exists = [...el.options].some(o => o.value == lvl.currentValue);
                if (exists) {
                    el.value = lvl.currentValue;
                    this.updateLink(levelIdx, lvl.currentValue);
                    // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≥—Ä—É–∑–∏–º —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
                    this.loadLevel(levelIdx + 1, lvl.currentValue);
                } else {
                    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —Ñ–∏–ª—å—Ç—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–º–µ–Ω–∏–ª–∏ –¥–æ–≥–æ–≤–æ—Ä), —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
                    lvl.currentValue = null; 
                }
            }
            
            // –ê–≤—Ç–æ-—Ä–µ—Å–∞–π–∑ –æ–∫–Ω–∞
            const height = document.body.scrollHeight + 20;
            BX24.placement.call('resizeWindow', { width: '100%', height: height });
        });
    },

    onChangeLevel: function(levelIdx) {
        const el = document.getElementById(`select-lvl-${levelIdx}`);
        const val = el.value;
        const lvl = this.levels[levelIdx];

        // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
        this.updateLink(levelIdx, val);

        // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ CRM
        this.saveToCRM(lvl.crmField, val);

        // 3. –ì—Ä—É–∑–∏–º —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
        if (levelIdx + 1 < this.levels.length) {
            this.loadLevel(levelIdx + 1, val);
        }
    },

    updateLink: function(levelIdx, recordId) {
        const lvl = this.levels[levelIdx];
        const linkEl = document.getElementById(`link-lvl-${levelIdx}`);
        
        if (recordId && App.domain) {
            linkEl.href = `https://${App.domain}/company/lists/${lvl.listId}/element/0/${recordId}/`;
            linkEl.style.display = 'flex';
        } else {
            linkEl.style.display = 'none';
        }
    },

    saveToCRM: function(fieldCode, value) {
        const method = App.config.entity === 'CRM_LEAD' ? 'crm.lead.update' : 'crm.deal.update';
        
        BX24.callMethod(method, {
            ID: this.dealId,
            FIELDS: { [fieldCode]: value }
        });
    }
};

// –ó–∞–ø—É—Å–∫
App.init();
</script>
</body>
</html>
